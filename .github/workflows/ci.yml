name: CI Pipeline

on:
  push:
    branches: [main, develop, "feature/**", "hotfix/**"]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ── 1. Lint (fastest job — fails fast) ───────────────────────────────────────
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff==0.4.4

      - name: Lint with ruff
        run: ruff check src/ tests/ scripts/ --output-format=github

      - name: Format check
        run: ruff format --check src/ tests/ scripts/

  # ── 2. Unit Tests ─────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Install only what unit tests need — skip torch/xgboost (slow, not needed for unit tests)
          pip install \
            fastapi uvicorn pydantic pydantic-settings \
            scikit-learn numpy pandas pyarrow scipy \
            mlflow redis structlog rich httpx \
            pytest pytest-asyncio pytest-cov pytest-mock pytest-timeout \
            python-jose PyYAML joblib imbalanced-learn \
            prometheus-client

      - name: Run unit tests
        run: |
          pytest tests/unit/ \
            -v \
            --timeout=60 \
            --ignore=tests/unit/test_xgboost_model.py \
            -p no:warnings
        env:
          ENV: test
          LOG_LEVEL: WARNING
          API_KEYS: dev-key-local,test-key

  # ── 3. Security Scan ──────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run Bandit
        run: |
          pip install bandit -q
          bandit -r src/ -ll -x tests/ -q || true

  # ── 4. Type Check ─────────────────────────────────────────────────────────────
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mypy + stubs
        run: pip install mypy pydantic pydantic-settings fastapi starlette

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports --no-error-summary
        continue-on-error: true  # Advisory only until full coverage

  # ── 5. CI Gate ────────────────────────────────────────────────────────────────
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, security]
    if: always()
    steps:
      - name: Check required jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ Lint failed" && exit 1
          fi
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "❌ Unit tests failed" && exit 1
          fi
          echo "✅ All required CI checks passed"
          echo ""
          echo "Skipped on CI (run locally):"
          echo "  • Docker build  — run: make docker-build"
          echo "  • Model training — run: make train-fast"
          echo "  • Integration tests — run: make test-integration"
