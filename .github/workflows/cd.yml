name: CD Pipeline

# Only run CD on version tags (v1.0.0) or manual trigger.
# NOT on every push to main — that's what CI is for.
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment target"
        required: true
        default: staging
        type: choice
        options: [staging, production]
      model_version:
        description: "Model version to deploy (leave empty for latest)"
        required: false
        type: string
      dry_run:
        description: "Dry run (validate config without deploying)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/fraudguard-api

jobs:
  # ── Validate secrets are configured ──────────────────────────────────────────
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    outputs:
      staging_ready: ${{ steps.check.outputs.staging_ready }}
      production_ready: ${{ steps.check.outputs.production_ready }}
    steps:
      - name: Check deployment secrets
        id: check
        run: |
          staging_ready=false
          production_ready=false

          if [ -n "${{ secrets.STAGING_HOST }}" ] && \
             [ -n "${{ secrets.STAGING_USER }}" ] && \
             [ -n "${{ secrets.STAGING_SSH_KEY }}" ]; then
            staging_ready=true
          fi

          if [ -n "${{ secrets.PROD_HOST }}" ] && \
             [ -n "${{ secrets.PROD_USER }}" ] && \
             [ -n "${{ secrets.PROD_SSH_KEY }}" ]; then
            production_ready=true
          fi

          echo "staging_ready=$staging_ready" >> $GITHUB_OUTPUT
          echo "production_ready=$production_ready" >> $GITHUB_OUTPUT

          echo "## Preflight Results" >> $GITHUB_STEP_SUMMARY
          echo "- Staging secrets configured: $staging_ready" >> $GITHUB_STEP_SUMMARY
          echo "- Production secrets configured: $production_ready" >> $GITHUB_STEP_SUMMARY

          if [ "$staging_ready" = "false" ] && [ "$production_ready" = "false" ]; then
            echo ""  >> $GITHUB_STEP_SUMMARY
            echo "⚠️ No deployment secrets are configured." >> $GITHUB_STEP_SUMMARY
            echo "Add secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions" >> $GITHUB_STEP_SUMMARY
          fi

  # ── Build & push Docker image ─────────────────────────────────────────────────
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: preflight
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.api
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Image build summary
        run: |
          echo "## Docker Image Built ✅" >> $GITHUB_STEP_SUMMARY
          echo "Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  # ── Deploy to Staging ─────────────────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: |
      needs.preflight.outputs.staging_ready == 'true' &&
      (github.event.inputs.dry_run != 'true') &&
      (github.event.inputs.environment == 'staging' || startsWith(github.ref, 'refs/tags/'))
    environment:
      name: staging
      url: https://fraudguard-staging.example.com

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/fraudguard-ml
            docker-compose -f docker-compose.prod.yml pull api
            docker-compose -f docker-compose.prod.yml up -d --no-deps api
            sleep 15
            curl -f http://localhost:8000/ready || exit 1
            echo "Staging deploy successful"

      - name: Run smoke tests
        run: |
          pip install httpx -q
          python scripts/smoke_test.py \
            --base-url ${{ secrets.STAGING_URL }} \
            --api-key ${{ secrets.STAGING_API_KEY }}

      - name: Staging deploy summary
        if: always()
        run: |
          echo "## Staging Deploy: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ── Deploy to Production ──────────────────────────────────────────────────────
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [preflight, deploy-staging]
    if: |
      needs.preflight.outputs.production_ready == 'true' &&
      github.event.inputs.dry_run != 'true' &&
      github.event.inputs.environment == 'production' &&
      startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      url: https://fraudguard-api.example.com

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to production via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/fraudguard-ml
            docker-compose -f docker-compose.prod.yml pull api
            docker-compose -f docker-compose.prod.yml up -d --no-deps api
            sleep 20
            curl -f http://localhost:8000/ready || exit 1

      - name: Production smoke test
        run: |
          pip install httpx -q
          python scripts/smoke_test.py \
            --base-url ${{ secrets.PROD_URL }} \
            --api-key ${{ secrets.PROD_API_KEY }} \
            --strict

  # ── Dry run summary ───────────────────────────────────────────────────────────
  dry-run-summary:
    name: Dry Run Summary
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: github.event.inputs.dry_run == 'true'
    steps:
      - name: Print dry run results
        run: |
          echo "## Dry Run Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This was a dry run. No servers were touched." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To do a real deploy:" >> $GITHUB_STEP_SUMMARY
          echo "1. Add deployment secrets in repo Settings → Secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Push a version tag: \`git tag v1.0.0 && git push origin v1.0.0\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required secrets for staging:" >> $GITHUB_STEP_SUMMARY
          echo "- STAGING_HOST, STAGING_USER, STAGING_SSH_KEY, STAGING_URL, STAGING_API_KEY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required secrets for production:" >> $GITHUB_STEP_SUMMARY
          echo "- PROD_HOST, PROD_USER, PROD_SSH_KEY, PROD_URL, PROD_API_KEY" >> $GITHUB_STEP_SUMMARY
