name: CD Pipeline

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment target"
        required: true
        default: staging
        type: choice
        options: [staging, production]
      model_version:
        description: "Model version to deploy (leave empty for latest)"
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/fraudguard-api

jobs:
  # â”€â”€ Deploy to Staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://fraudguard-staging.company.com
    concurrency:
      group: staging-deploy
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: image
        run: |
          SHA=$(echo ${{ github.sha }} | head -c7)
          echo "tag=sha-${SHA}" >> $GITHUB_OUTPUT

      - name: Deploy to staging via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/fraudguard-ml
            export IMAGE_TAG=${{ steps.image.outputs.tag }}
            export MODEL_VERSION=${{ github.event.inputs.model_version || 'latest' }}
            docker-compose -f docker-compose.prod.yml pull api
            docker-compose -f docker-compose.prod.yml up -d --no-deps api
            sleep 15
            curl -f http://localhost:8000/ready || (echo "Readiness check failed!" && exit 1)

      - name: Run smoke tests against staging
        run: |
          pip install httpx
          python scripts/smoke_test.py \
            --base-url https://fraudguard-staging.company.com \
            --api-key ${{ secrets.STAGING_API_KEY }}

      - name: Notify Slack on staging deploy
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ FraudGuard ML deployed to *staging*\nCommit: ${{ github.sha }}\nStatus: ${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # â”€â”€ Blue/Green Production Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    name: Deploy to Production (Blue/Green)
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://fraudguard-api.company.com

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.model_version || 'latest' }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy green instance
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/fraudguard-ml

            # Start green deployment (new version on alternate port)
            export MODEL_VERSION=${{ steps.version.outputs.version }}
            export DEPLOY_COLOR=green
            docker-compose -f docker-compose.prod.yml \
              -p fraudguard-green \
              up -d api

            # Wait for green to be healthy
            for i in $(seq 1 12); do
              if curl -f http://localhost:8001/ready; then
                echo "Green instance healthy after ${i}0s"
                break
              fi
              sleep 10
              if [ $i -eq 12 ]; then
                echo "Green instance failed health check"
                docker-compose -f docker-compose.prod.yml -p fraudguard-green down
                exit 1
              fi
            done

            # Switch nginx upstream to green (blue/green swap)
            sed -i 's/server 127.0.0.1:8000/server 127.0.0.1:8001/g' /etc/nginx/conf.d/fraudguard.conf
            nginx -s reload

            # Drain and stop blue
            sleep 30
            docker-compose -f docker-compose.prod.yml -p fraudguard-blue down || true
            
            echo "Blue/green deploy complete. Running on green (port 8001)"

      - name: Production smoke test
        run: |
          pip install httpx
          python scripts/smoke_test.py \
            --base-url https://fraudguard-api.company.com \
            --api-key ${{ secrets.PROD_API_KEY }} \
            --strict

      - name: Tag production release in MLflow
        run: |
          python -c "
          import mlflow
          mlflow.set_tracking_uri('${{ secrets.MLFLOW_TRACKING_URI }}')
          client = mlflow.tracking.MlflowClient()
          versions = client.search_model_versions(\"name='fraudguard-ensemble'\")
          for v in versions:
              if v.current_stage == 'Production':
                  client.set_model_version_tag(
                      name='fraudguard-ensemble',
                      version=v.version,
                      key='deployed_sha',
                      value='${{ github.sha }}'
                  )
          "
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

      - name: Notify Slack on production deploy
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && 'âœ…' || 'ðŸ”´' }} FraudGuard ML *production* deploy\nVersion: ${{ steps.version.outputs.version }}\nCommit: ${{ github.sha }}\nStatus: ${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # â”€â”€ Rollback Job (Manual trigger) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    environment: production

    steps:
      - name: Rollback to previous blue
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Swap nginx back to blue
            sed -i 's/server 127.0.0.1:8001/server 127.0.0.1:8000/g' /etc/nginx/conf.d/fraudguard.conf
            nginx -s reload
            echo "Rolled back to blue instance"
